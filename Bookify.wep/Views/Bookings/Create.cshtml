@model Bookify.wep.Models.Bookings.BookingCreateViewModel

@{
    ViewData["Title"] = "Complete Your Booking";
    var roomType = ViewBag.RoomType as string ?? "Room";
    // try to use model RoomPrice if passed; fallback to ViewBag.RoomPrice if present
    var pricePerNight = Model?.RoomPrice ?? (ViewBag.RoomPrice != null ? (decimal)Convert.ToDecimal(ViewBag.RoomPrice) : 0m);
    var nights = (Model?.CheckOut.AddDays(0) ?? DateTime.Today).Subtract(Model?.CheckIn ?? DateTime.Today.AddDays(1)).Days;
    if (nights < 1) nights = 1;
    var totalServer = Model?.TotalPrice ?? (pricePerNight * nights);
}

<link rel="stylesheet" href="~/css/checkout-styles.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<header class="navbar">
    <a asp-controller="Home" asp-action="Index" class="logo">Seaside Hotel</a>
    <nav class="nav-links">
        <a asp-controller="Home" asp-action="Index">Home</a>
        <a asp-controller="Rooms" asp-action="Index">Rooms</a>
    </nav>
</header>

<div class="checkout-page-container container">
    <h2 class="page-title">Finalize Your Booking</h2>

    <div class="checkout-layout">
        <div class="booking-details-column">
            <section class="section-box room-summary">
                <h3><i class="fas fa-bed"></i> Booking Details</h3>
                <div class="room-info">
                    <div class="room-image-small"></div>
                    <div class="text-info">
                        <h4>@roomType</h4>
                        <p>Check-in: <span id="ci-display">@Model.CheckIn.ToString("dd MMM, yyyy")</span></p>
                        <p>Check-out: <span id="co-display">@Model.CheckOut.ToString("dd MMM, yyyy")</span></p>
                        <p>Nights: <span id="nights-display">@((Model.CheckOut - Model.CheckIn).Days)</span> | Guests: <span id="guests-display">@Model.Guests</span></p>
                    </div>
                </div>
            </section>

            <section class="section-box guest-info">
                <h3><i class="fas fa-user"></i> Guest Information</h3>

                @* FOR POST: send to Checkout action which creates Stripe session *@
                <form id="booking-form" method="post" asp-controller="Bookings" asp-action="Checkout">
                    @Html.AntiForgeryToken()

                    @* Hidden binding fields so server receives all necessary data *@
                    <input asp-for="RoomId" type="hidden" />
                    <input asp-for="Guests" type="hidden" />
                    <input asp-for="CheckIn" type="hidden" />
                    <input asp-for="CheckOut" type="hidden" />

                    @* Price fields (calculated server-side in GET Create and re-calculated in Checkout) *@
                    <input asp-for="RoomPrice" type="hidden" />
                    <input asp-for="TotalPrice" type="hidden" />

                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="form-group">
                        <label asp-for="FullName">Full Name</label>
                        <input asp-for="FullName" class="form-control" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Email">Email Address</label>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Phone">Phone Number</label>
                        <input asp-for="Phone" class="form-control" />
                        <span asp-validation-for="Phone" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="SpecialRequests">Special Requests (PUT "NO" IF NOT)</label>
                        <textarea asp-for="SpecialRequests" class="form-control"></textarea>
                    </div>

                    <div style="margin-top:12px;">
                        <button type="submit" class="btn primary-btn final-pay-btn">Complete Booking</button>
                        <a asp-controller="Rooms" asp-action="Index" class="btn secondary-btn">Cancel</a>
                    </div>
                </form>
            </section>
        </div>

        <div class="payment-summary-column">
            <section class="section-box price-summary">
                <h3><i class="fas fa-receipt"></i> Price Summary</h3>
                <div class="price-line">
                    <span id="line-nights">@((Model.CheckOut - Model.CheckIn).Days) Nights (@roomType)</span>
                    <span id="line-amount">@String.Format("{0:C}", pricePerNight * (Model.CheckOut - Model.CheckIn).Days)</span>
                </div>
                <div class="price-line"><span>Taxes & Fees (15%)</span><span id="tax-amount">@String.Format("{0:C}", (pricePerNight * (Model.CheckOut - Model.CheckIn).Days) * 0.15m)</span></div>
                <div class="price-total"><span>Total Due Now</span><span id="total-amount">@String.Format("{0:C}", totalServer * 1m)</span></div>
                @* Note: server already included taxes if you set it in vm.TotalPrice; above shows simple calc based on RoomPrice *@
            </section>

            <section class="section-box payment-form">
                <h3><i class="fas fa-credit-card"></i> Payment</h3>
                <p>You'll be redirected to the payment page after pressing "Complete Booking".</p>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="~/js/nav.js"></script>

    @* include unobtrusive validation scripts so ModelState errors show *@
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function(){
            // values from server (safe)
            const pricePerNight = parseFloat('@pricePerNight.ToString(System.Globalization.CultureInfo.InvariantCulture)');
            const ciStr = '@Model.CheckIn.ToString("yyyy-MM-dd")';
            const coStr = '@Model.CheckOut.ToString("yyyy-MM-dd")';

            const ci = new Date(ciStr + 'T00:00:00');
            const co = new Date(coStr + 'T00:00:00');

            const msPerDay = 24*60*60*1000;
            const nights = Math.round((co - ci) / msPerDay);
            if(!isNaN(nights) && nights > 0) {
                const base = pricePerNight * nights;
                const tax = base * 0.15;
                const total = base + tax;
                document.getElementById('line-amount').textContent = base.toLocaleString(undefined, {style:'currency', currency:'USD'});
                document.getElementById('tax-amount').textContent = tax.toLocaleString(undefined, {style:'currency', currency:'USD'});
                document.getElementById('total-amount').textContent = total.toLocaleString(undefined, {style:'currency', currency:'USD'});
            }

            const form = document.getElementById('booking-form');
            form.addEventListener('submit', function(e){
                // nothing fancy: allow submit; server will re-calc price and create Stripe session
            });

        })();
    </script>
}
